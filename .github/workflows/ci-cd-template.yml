name: CI/CD Template

on:
  workflow_call:
    inputs:
      branch-name:
        description: "Branch that triggered the workflow"
        required: true
        type: string
      environment:
        description: "Deployment environment (dev, stage, uat, prod)"
        required: true
        type: string
      docker-image-tag:
        description: "Docker image tag to build and deploy"
        required: true
        type: string
    secrets:
      DOCKER_PAT:
        description: "Docker Personal Access Token"
        required: true

# -------------------------------
# Job 1: Code Scanning
# -------------------------------
jobs:
  scan:
    name: CodeQL Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

# -------------------------------
# Job 2: Build & Push Image
# -------------------------------
  build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: scan
    env:
      DOCKER_USERNAME: nareshpama
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PAT }}
      REGISTRY: docker.io
      IMAGE_NAME: project-poc
      TAG: ${{ inputs.docker-image-tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}
          registry: ${{ env.REGISTRY }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          echo "Building Docker image: ${{ env.IMAGE_NAME }}:${{ env.TAG }}"
          docker build -t ${{ env.IMAGE_NAME }}:${{ env.TAG }} .

      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ env.TAG }}
          format: 'table'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
        continue-on-error: true

      - name: Push Docker image
        run: |
          echo "Pushing Docker image to DockerHub..."
          docker tag ${{ env.IMAGE_NAME }}:${{ env.TAG }} \
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.TAG }}
          docker push ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.TAG }}

# -------------------------------
# Job 3: Deploy
# -------------------------------
  deploy:
    name: Deploy to Environment
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: ${{ inputs.environment }}
    env:
      IMAGE_NAME: project-poc
      TAG: ${{ inputs.docker-image-tag }}
      ENVIRONMENT: ${{ inputs.environment }}
      BRANCH: ${{ inputs.branch-name }}

    steps:
      - name: Checkout repo (optional)
        uses: actions/checkout@v4

      - name: Deploy to target environment
        run: |
          echo "---------------------------------------"
          echo "ðŸš€ Deploying ${{ env.IMAGE_NAME }}:${{ env.TAG }}"
          echo "ðŸŒ¿ Branch: ${{ env.BRANCH }}"
          echo "ðŸŒŽ Environment: ${{ env.ENVIRONMENT }}"
          echo "---------------------------------------"
          # Example deploy command:
          # kubectl apply -f k8s/${{ env.ENVIRONMENT }}/deployment.yaml
