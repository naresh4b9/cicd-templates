name: CI/CD Template

on:
  workflow_call:
    inputs:
      branch-name:
        type: string
        required: true
      environment:
        type: string
        required: true
      docker-image-tag:
        type: string
        required: true
    secrets:
      DOCKER_PAT:
        required: true
      GHCR_PAT:
        required: true

jobs:
# ==========================================================
# 1Ô∏è‚É£ BUILD STAGE
# ==========================================================
  build:
    name: üèóÔ∏è Build Docker Image
    runs-on: ubuntu-latest
    outputs:
      SHORT_SHA: ${{ steps.vars.outputs.short_sha }}
    env:
      IMAGE_NAME: project-poc
      GHCR_IMAGE: ghcr.io/${{ github.repository_owner }}/project-poc

    steps:
      - uses: actions/checkout@v4

      - name: Set commit short SHA
        id: vars
        run: |
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-8)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Build & Push Image to GHCR (temporary)
        run: |
          IMAGE_TAG=${{ inputs.branch-name }}-${{ steps.vars.outputs.short_sha }}
          echo "üèóÔ∏è Building and pushing temporary image: $GHCR_IMAGE:${IMAGE_TAG}"
          docker build -t $GHCR_IMAGE:${IMAGE_TAG} .
          docker push $GHCR_IMAGE:${IMAGE_TAG}

# ==========================================================
# 2Ô∏è‚É£ SCAN STAGE
# ==========================================================
  codeql-scan:
    name: üîç CodeQL Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect languages
        id: detect_langs
        run: |
          langs=""
          if ls **/*.py 1> /dev/null 2>&1; then langs="${langs}python,"; fi
          if ls **/*.csproj 1> /dev/null 2>&1; then langs="${langs}csharp,"; fi
          if ls **/*.js 1> /dev/null 2>&1; then langs="${langs}javascript,"; fi
          langs="${langs%,}"
          echo "langs=$langs" >> $GITHUB_OUTPUT

      - name: Initialize CodeQL
        if: steps.detect_langs.outputs.langs != ''
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ steps.detect_langs.outputs.langs }}

      - name: Manual build for .NET (if present)
        if: contains(steps.detect_langs.outputs.langs, 'csharp')
        run: |
          dotnet restore
          dotnet build --no-incremental

      - name: Perform CodeQL Analysis
        if: steps.detect_langs.outputs.langs != ''
        uses: github/codeql-action/analyze@v3

      - name: Skip message
        if: steps.detect_langs.outputs.langs == ''
        run: echo "‚è≠Ô∏è No supported code found, skipping CodeQL."

  secret-scan:
    name: üïµÔ∏è Secret & Dependency Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run dependency review (if PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/dependency-review-action@v4
      - name: Run secret scan (always)
        run: echo "üîê Running secret scan (placeholder)"

  docker-scan:
    name: üê≥ Trivy Docker Image Scan
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Trivy scan on GHCR image
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: ghcr.io/${{ github.repository_owner }}/project-poc:${{ inputs.branch-name }}-${{ needs.build.outputs.SHORT_SHA }}
          format: 'table'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
        continue-on-error: false

  dotnet-scan:
    name: üß© .NET Code Scan
    runs-on: ubuntu-latest
    steps:
      - name: Check .NET project
        id: check_dotnet
        run: |
          if ls **/*.csproj 1> /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      - name: Checkout repo
        if: steps.check_dotnet.outputs.exists == 'true'
        uses: actions/checkout@v4
      - name: Setup .NET
        if: steps.check_dotnet.outputs.exists == 'true'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - name: Build & Scan
        if: steps.check_dotnet.outputs.exists == 'true'
        run: |
          dotnet restore
          dotnet build --no-incremental
          dotnet list package --vulnerable
      - name: Skip message
        if: steps.check_dotnet.outputs.exists == 'false'
        run: echo "‚è≠Ô∏è Skipping .NET scan ‚Äî no .csproj found."

# ==========================================================
# 3Ô∏è‚É£ PUSH STAGE
# ==========================================================
  push:
    name: üêã Push Docker Image
    runs-on: ubuntu-latest
    needs: [build, codeql-scan, secret-scan, docker-scan, dotnet-scan]
    if: |
      always() &&
      needs.build.result == 'success' &&
      (
        needs.codeql-scan.result == 'success' &&
        needs.secret-scan.result == 'success' &&
        (needs.docker-scan.result == 'success' || needs.docker-scan.result == 'skipped') &&
        (needs.dotnet-scan.result == 'success' || needs.dotnet-scan.result == 'skipped')
      )
    env:
      DOCKER_USERNAME: nareshpama
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PAT }}
      IMAGE_NAME: project-poc
      GHCR_IMAGE: ghcr.io/${{ github.repository_owner }}/project-poc

    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Pull from GHCR and push to Docker Hub
        run: |
          SHORT_SHA=${{ needs.build.outputs.SHORT_SHA }}
          IMAGE_TAG=${{ inputs.branch-name }}-${SHORT_SHA}
          echo "Pulling GHCR image: $GHCR_IMAGE:${IMAGE_TAG}"
          docker pull $GHCR_IMAGE:${IMAGE_TAG}
          docker tag $GHCR_IMAGE:${IMAGE_TAG} docker.io/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}
          echo "Pushing final image to Docker Hub..."
          docker push docker.io/${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}

      - name: Cleanup temporary GHCR image
        env:
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
        run: |
          echo "üßπ Cleaning up temporary GHCR image..."
          IMAGE_TAG=${{ inputs.branch-name }}-${{ needs.build.outputs.SHORT_SHA }}
          TOKEN=$(echo -n "${GHCR_PAT}" | base64)
          echo "Deleting manifest for $GHCR_IMAGE:${IMAGE_TAG}"
          curl -X DELETE \
            -H "Authorization: Bearer ${GHCR_PAT}" \
            "https://ghcr.io/v2/${{ github.repository_owner }}/project-poc/manifests/${IMAGE_TAG}" || true

# ==========================================================
# 4Ô∏è‚É£ DEPLOY STAGE
# ==========================================================
  deploy:
    name: üöÄ Deploy Application
    runs-on: ubuntu-latest
    needs: push
    environment:
      name: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Environment
        run: |
          echo "-------------------------------------------"
          echo "Deploying to: ${{ inputs.environment }}"
          echo "Branch: ${{ inputs.branch-name }}"
          echo "Image: nareshpama/project-poc:${{ inputs.branch-name }}-${{ needs.build.outputs.SHORT_SHA }}"
          echo "-------------------------------------------"
